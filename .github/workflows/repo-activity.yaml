name: "Report repository activity"
on:
  pull_request:
  push:
    branches:
      - master
  schedule:
    - cron:  '0 * * * *'  # run every hour

jobs:
  repo_activity:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:bionic
    strategy:
      fail-fast: false
      matrix:
        # All ROS 2 repositories. Generated by the following command:
        # curl https://raw.githubusercontent.com/ros2/ros2/master/ros2.repos | sed -n -e 's/^  \(.*\):$/\1/gp' | sort | uniq
        repo: [
          "ros-tooling/action-amazon-chime",
          "ros-tooling/action-pypi",
          "ros-tooling/action-ros-ci-template",
          "ros-tooling/cross_compile",
          "ros-tooling/github-contribution-report-generator",
          "ros-tooling/aws-oncall",
          "ros-tooling/action-repository-activity",
          "ros-tooling/action-ros-lint",
          "ros-tooling/action-ros-ci",
          "ros-tooling/setup-ros",
          "ros-tooling/launch_ros_sandbox",
          "ros-tooling/system_metrics_collector",
          "ros-tooling/libstatistics_collector",
          "ros2/rosbag2"
          ]

    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - uses: ros-tooling/action-repository-activity@0.0.1
      id: repo_activity
      with:
        repository: ${{ matrix.repo }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: open_issues_count
        metric-value: ${{ steps.repo_activity.outputs.open_issues_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: archived
        metric-value: ${{ steps.repo_activity.outputs.archived }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: disabled
        metric-value: ${{ steps.repo_activity.outputs.disabled }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: forks_count
        metric-value: ${{ steps.repo_activity.outputs.forks_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: network_count
        metric-value: ${{ steps.repo_activity.outputs.network_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: open_issues_count
        metric-value: ${{ steps.repo_activity.outputs.open_issues_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: stargazers_count
        metric-value: ${{ steps.repo_activity.outputs.stargazers_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: subscribers_count
        metric-value: ${{ steps.repo_activity.outputs.subscribers_count }}
    - uses: ros-tooling/action-cloudwatch-metrics@0.0.4
      with:
        metric-dimensions: >-
          [
            { "Name": "github.event_name", "Value": "${{ github.event_name }}" },
            { "Name": "github.ref", "Value": "${{ github.ref }}" },
            { "Name": "github.repository", "Value": "${{ matrix.repo }}" }
          ]
        metric-name: watchers_count
        metric-value: ${{ steps.repo_activity.outputs.watchers_count }}
